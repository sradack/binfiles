#!/bin/bash

set -e

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: Not a git repository"
    exit 1
fi

# Check if there are staged changes
if git diff --cached --quiet; then
    echo "Error: No staged changes to commit"
    echo "Use 'git add' to stage changes first"
    exit 1
fi

# Get the staged diff
DIFF=$(git diff --cached)

# Get recent commit messages for style reference
RECENT_COMMITS=$(git log -5 --pretty=format:"%s" 2>/dev/null || echo "")

# Generate commit message using claude
echo "Generating commit message..."
PROMPT="Based on the following staged changes, write a git commit message with:
- A summary line using conventional commit format (feat:, fix:, refactor:, docs:, style:, test:, chore:, perf:, ci:, build:, etc.)
- Uses imperative mood (e.g., 'Add feature' not 'Added feature')
- A blank line after the summary
- A description body explaining what changed and why, based on the diff
- Does NOT include any attribution, signature, or mention of AI/Claude/Anthropic

Recent commits in this repo for style reference:
$RECENT_COMMITS

Staged changes:
\`\`\`
$DIFF
\`\`\`

Respond with ONLY the commit message (summary + blank line + description), no other text."

COMMIT_MSG=$(claude -p "$PROMPT" < /dev/null)

# Commit with the generated message
echo "$COMMIT_MSG" | git commit -F -

# Display the commit message that was used
echo ""
echo "Committed with message:"
echo "------------------------"
echo "$COMMIT_MSG"
echo "------------------------"
